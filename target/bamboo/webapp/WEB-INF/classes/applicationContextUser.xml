<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:plugin="http://atlassian.com/schema/spring/plugin"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       http://atlassian.com/schema/spring/plugin http://atlassian.com/schema/spring/plugin.xsd">

  <!-- BambooAuthenticationContext -->
  <bean id="authenticationContext" class="com.atlassian.bamboo.user.DefaultAuthenticationContext" plugin:available="true">
    <property name="bambooUserManager" ref="bambooUserManager" />
  </bean>

  <!-- Bamboo User Manager -->
  <bean id="bambooUserManager" parent="txUserReadWriteProxy" plugin:available="true">
    <property name="target">
      <bean class="com.atlassian.bamboo.user.BambooUserManagerImpl" >
        <property name="authorDao" ref="authorDao"/>
        <property name="commentDao" ref="commentDao" />
        <property name="labelDao" ref="labelDao" />
        <property name="aclService" ref="aclService"/>
        <property name="aclAuthorizationStrategy" ref="aclAuthorizationStrategy"/>
        <property name="atlassianUserConfiguration" ref="atlassianUserConfiguration" />
        <property name="loginInformationManager" ref="loginInformationManager" />
        <property name="tokenDao" ref="tokenDao" />
        <property name="rememberMeTokenDao" ref="bambooRememberMeTokenDao"/>
      </bean>
    </property>
  </bean>

  <bean id="txUserReadWriteProxy" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean" abstract="true">
    <property name="transactionManager" ref="transactionManager"/>
    <property name="transactionAttributes">
      <props>
        <prop key="saveExternalEntity">PROPAGATION_REQUIRES_NEW</prop>
        <prop key="getPropertySet*">PROPAGATION_REQUIRED</prop>
        <prop key="get*">PROPAGATION_REQUIRED,readOnly</prop>
        <prop key="is*">PROPAGATION_REQUIRED,readOnly</prop>
        <prop key="has*">PROPAGATION_REQUIRED,readOnly</prop>
        <prop key="load*">PROPAGATION_REQUIRED,readOnly</prop>
        <prop key="filter*">PROPAGATION_REQUIRED,readOnly</prop>
        <prop key="*">PROPAGATION_REQUIRED</prop>
      </props>
    </property>
  </bean>


  <bean id="atlassianUserConfiguration" class="com.atlassian.bamboo.user.BambooUserConfiguration" >
    <property name="sessionFactory" ref="sessionFactory"/>
    <property name="cacheManager" ref="cacheManager"/>
    <property name="externalEntityDao" ref="externalEntityDao"/> 
  </bean>

  <bean id="delegationAccessor" factory-bean="atlassianUserConfiguration" factory-method="getDelegationAccessor"/>
  <bean id="authenticator" factory-bean="delegationAccessor" factory-method="getAuthenticator"/>
  <bean id="entityQueryParser" factory-bean="delegationAccessor" factory-method="getEntityQueryParser"/>

  <bean id="userManager" parent="txReadWriteProxy">
    <property name="target">
      <bean factory-bean="delegationAccessor" factory-method="getUserManager" />
    </property>
  </bean>

  <bean id="groupManager" parent="txReadWriteProxy">
    <property name="target">
      <bean factory-bean="delegationAccessor" factory-method="getGroupManager"/>
    </property>
  </bean>

  <bean id="propertySetFactory" parent="txReadWriteProxy">
    <property name="target">
      <bean factory-bean="delegationAccessor" factory-method="getPropertySetFactory"/>
    </property>
  </bean>

  <bean id="externalEntityDao" parent="txUserReadWriteProxy">
    <property name="target">
      <bean class="com.atlassian.user.impl.hibernate.CachingExternalEntityDAO">
        <property name="cacheManager" ref="cacheManager"/>
        <property name="sessionFactory" ref="sessionFactory"/>
      </bean>
    </property>
  </bean>

</beans>
