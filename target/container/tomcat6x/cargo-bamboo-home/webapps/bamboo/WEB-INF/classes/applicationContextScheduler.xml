<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:plugin="http://atlassian.com/schema/spring/plugin"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       http://atlassian.com/schema/spring/plugin http://atlassian.com/schema/spring/plugin.xsd">
  
  <bean id="scheduler" class="org.springframework.scheduling.quartz.SchedulerFactoryBean">
    <property name="quartzProperties">
      <props>
          <prop key="org.quartz.scheduler.skipUpdateCheck">true</prop>
          <prop key="org.quartz.threadPool.class">com.atlassian.bamboo.quartz.SystemAuthorizedThreadPool</prop>
      </props>
    </property>
    <property name="jobFactory" ref="jobFactory"/>
    <property name="triggerListeners">
      <list>
        <bean class="com.atlassian.bamboo.quartz.PreventJobExecutionUntilCompletedTriggerListener" />
      </list>
    </property>
  </bean>

  <bean id="jobFactory" class="com.atlassian.bamboo.quartz.AutowiringJobFactory"/>

  <bean id="scheduleBackupBean" class="com.atlassian.bamboo.configuration.ScheduleBackupBeanImpl">
    <property name="scheduler" ref="scheduler"/>
  </bean>

  <bean id="bambooSchedulers" class="org.springframework.beans.factory.config.ListFactoryBean">
    <property name="sourceList">
      <list>
        <ref local="elasticInstanceScheduleScheduler" />
        <ref local="buildExpiryScheduler" />
        <ref local="elasticInstancesMonitor" />
        <ref local="orphanedBuildMonitorJobScheduler"/>
        <ref local="deletionScheduler"/>
        <ref local="rememberMeTokenExpiryScheduler"/>
      </list>
    </property>
  </bean>

  <bean id="elasticInstanceScheduleScheduler" class="com.atlassian.bamboo.agent.elastic.schedule.ElasticInstanceScheduleScheduler">
    <constructor-arg ref="elasticInstanceScheduleDao"/>
    <constructor-arg ref="scheduler"/>
  </bean>

  <bean id="buildExpiryScheduler" class="com.atlassian.bamboo.build.expiry.BuildExpiryScheduler">
    <constructor-arg ref="administrationConfigurationManager"/>
    <constructor-arg ref="scheduler"/>
  </bean>


  <bean id="heartBeatCheckerJobScheduler" class="com.atlassian.bamboo.v2.build.agent.HeartBeatCheckerJobScheduler">
    <constructor-arg value="${bamboo.agent.heartbeatCheckInterval}"/>
    <property name="scheduler" ref="scheduler"/>
  </bean>

  <bean id="buildMonitorJobScheduler" class="com.atlassian.bamboo.build.monitoring.BuildMonitorJobScheduler">
    <property name="buildCheckInterval" value="${bamboo.buildHangingMonitor.checkInterval}"/>
    <property name="scheduler" ref="scheduler"/>
    <property name="buildHangingMonitor" ref="buildHangingMonitor"/>
  </bean>

  <bean id="buildHangingMonitor" class="com.atlassian.bamboo.build.monitoring.BuildHangingMonitor">
    <property name="planManager" ref="planManager"/>
    <property name="buildExecutionManager" ref="buildExecutionManager"/>
    <property name="persister" ref="persister"/>
    <property name="eventManager" ref="eventManager"/>
  </bean>

  <bean id="buildQueueMonitorJobScheduler" class="com.atlassian.bamboo.build.monitoring.BuildQueueMonitorJobScheduler">
    <property name="buildQueueCheckInterval" value="${bamboo.buildQueueMonitor.checkInterval}"/>
    <property name="scheduler" ref="scheduler"/>
    <property name="buildQueueMonitor" ref="buildQueueMonitor"/>
  </bean>

  <bean id="buildQueueMonitor" class="com.atlassian.bamboo.build.monitoring.BuildQueueMonitor">
    <property name="administrationConfigurationManager" ref="administrationConfigurationManager" />
    <property name="planManager"  ref="planManager" />
    <property name="buildExecutionManager" ref="buildExecutionManager"/>
    <property name="eventManager" ref="eventManager"/>
    <property name="buildQueueManager" ref="buildQueueManager"/>
  </bean>

  <bean id="orphanedBuildMonitorJobScheduler" class="com.atlassian.bamboo.build.monitoring.OrphanedBuildMonitorJobScheduler">
    <constructor-arg ref="scheduler"/>
    <constructor-arg value="${bamboo.agent.heartbeatTimeoutSeconds}"/>
    <constructor-arg value="${bamboo.agent.heartbeatInterval}"/>
  </bean>
  
  <bean id="elasticInstancesMonitor" class="com.atlassian.bamboo.agent.elastic.schedule.ElasticInstancesMonitor">
    <constructor-arg ref="scheduler"/>
  </bean>
  
  <bean id="elasticRunningInstancesOptimizer" class="com.atlassian.bamboo.agent.elastic.schedule.ElasticRunningInstancesOptimizer">
    <constructor-arg ref="buildQueueManager"/>
    <constructor-arg ref="localAgentManager"/>
    <constructor-arg ref="planManager"/>
    <constructor-arg ref="elasticInstanceManager"/>
    <constructor-arg ref="elasticAccountBean"/>
    <constructor-arg ref="buildExecutionManager"/>
    <constructor-arg ref="bambooLicenseManager"/>
    <constructor-arg ref="buildResultsSummaryManager"/>
    <constructor-arg ref="administrationConfigurationManager"/>
    <constructor-arg ref="textProvider"/>
  </bean>

  <bean id="deletionScheduler" class="com.atlassian.bamboo.deletion.DeletionScheduler">
    <constructor-arg ref="scheduler"/>
  </bean>

  <bean id="rememberMeTokenExpiryScheduler" class="com.atlassian.bamboo.security.RememberMeTokenExpiryScheduler">
    <constructor-arg ref="scheduler"/>
  </bean>
</beans>
