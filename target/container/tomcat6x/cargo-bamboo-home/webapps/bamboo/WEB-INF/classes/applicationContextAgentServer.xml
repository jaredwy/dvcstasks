<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN 2.0//EN" "http://www.springframework.org/dtd/spring-beans-2.0.dtd">

<beans>

  <bean id="agentServerManager" class="com.atlassian.bamboo.agent.classserver.AgentServerManagerImpl">
    <constructor-arg ref="bootstrapManager"/>
    <constructor-arg>
      <map>
      	<entry key="bamboo.agent.brokerUrl" value="${bamboo.jms.broker.client.uri}"/>
        <entry key="bamboo.agent.heartbeatInterval" value="${bamboo.agent.heartbeatInterval}"/>
      </map>
    </constructor-arg>
  </bean>

  <alias name="elasticAgentManager" alias="elasticInstanceManager" />

  <bean id="elasticAccountBean" class="com.atlassian.bamboo.agent.elastic.server.ElasticAccountBeanImpl">
    <constructor-arg ref="administrationConfigurationManager" />
    <constructor-arg ref="eventManager" />
  </bean>

  <bean id="awsAccountBean" class="com.atlassian.bamboo.agent.elastic.aws.AwsAccountBeanImpl">
    <constructor-arg ref="elasticAccountBean" />
    <constructor-arg>
      <bean class="com.atlassian.aws.AWSManagerImpl">
        <constructor-arg>
          <bean class="com.atlassian.aws.Ec2ClientFactoryImpl">
            <constructor-arg value="${bamboo.ec2.server}" type="java.lang.String" />
            <constructor-arg value="${bamboo.ec2.port}" type="int"/>
          </bean>
        </constructor-arg>
        <constructor-arg ref="scheduledExecutorService"/>
      </bean>
    </constructor-arg>
  </bean>


  <bean id="elasticAgentManager" class="com.atlassian.bamboo.agent.elastic.server.ElasticInstanceManagerImpl">
    <constructor-arg ref="awsAccountBean"/>
    <constructor-arg ref="administrationConfigurationManager"/>
    <constructor-arg value="${bamboo.agent.elastic.startupTimeoutSeconds}"/>
    <constructor-arg ref="scheduledExecutorService"/>
    <constructor-arg>
      <bean class="com.atlassian.bamboo.agent.elastic.tunnel.KeyStoreFactoryImpl"/>
    </constructor-arg>
    <constructor-arg>
      <bean class="com.atlassian.bamboo.agent.elastic.tunnel.SSLContextFactoryImpl">
        <constructor-arg index="0">
          <bean class="javax.net.ssl.KeyManagerFactory" factory-method="getDefaultAlgorithm"/>
        </constructor-arg>
        <constructor-arg index="1">
          <bean class="javax.net.ssl.TrustManagerFactory" factory-method="getDefaultAlgorithm"/>
        </constructor-arg>
      </bean>
    </constructor-arg>
    <constructor-arg ref="bootstrapManager"/>
    <constructor-arg ref="errorHandler" />
    <constructor-arg>
      <bean class="com.atlassian.bamboo.agent.elastic.server.EBSVolumeSupervisorFactoryImpl">
        <constructor-arg index="0" ref="scheduledExecutorService"/>
        <constructor-arg index="1" value="${bamboo.agent.elastic.ebsVolumeSupervisionIntervalInSeconds}"/>
      </bean>
    </constructor-arg>
  </bean>


  <bean id="scheduledExecutorService" class="java.util.concurrent.Executors" factory-method="newScheduledThreadPool">
    <constructor-arg value="3"/>
  </bean>

  <bean id="resourceResolver" class="com.atlassian.bamboo.utils.ResourceResolver">
    <constructor-arg ref="bootstrapManager" />
  </bean>

  <bean id="defaultAgentCapabilityManager" class="com.atlassian.bamboo.v2.build.agent.capability.DefaultAgentCapabilityManagerImpl">
    <constructor-arg ref="resourceResolver"/>
  </bean>


</beans>
